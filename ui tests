local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

local MESH_ID_TARGET = "rbxassetid://12439777368"
local SERVER_LOG_FILE = "fluent_server_history.json"

local webhookURL = ""
local isInitialized = false 

-- Helper Functions
local function sendWebhook(title, message)
    if webhookURL ~= "" and webhookURL:find("discord.com/api/webhooks") then
        local data = {["embeds"] = {{["title"] = title, ["description"] = message, ["color"] = 0x00ff00}}}
        pcall(function()
            request({
                Url = webhookURL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(data)
            })
        end)
    end
end

local function serverHop()
    local history = isfile(SERVER_LOG_FILE) and HttpService:JSONDecode(readfile(SERVER_LOG_FILE)) or {}
    history[game.JobId] = os.time()
    writefile(SERVER_LOG_FILE, HttpService:JSONEncode(history))

    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    end)

    if success and result.data then
        for _, server in ipairs(result.data) do
            if server.playing < server.maxPlayers and not history[server.id] then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

-- UI Setup
local Window = Fluent:CreateWindow({
    Title = "Premium Utility",
    SubTitle = "Fluent Edition",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Theme = "Dark"
})

local Tabs = {
    Automation = Window:AddTab({ Title = "Automation", Icon = "play" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- [[ LOOP LOGIC ]]
local function startHopperLoop()
    task.spawn(function()
        while Fluent.Options.HopperToggle.Value do
            local target = workspace:FindFirstChild("map") 
                and workspace.map:FindFirstChild("Rokyo") 
                and workspace.map.Rokyo:FindFirstChild("MeshPart")

            if target and target.MeshId == MESH_ID_TARGET then
                sendWebhook("âœ… Target Found!", "Found in: " .. game.JobId)
                Fluent:Notify({Title = "Success", Content = "Target Found!", Duration = 5})
                Fluent.Options.HopperToggle:SetValue(false)
                break
            else
                serverHop()
            end
            task.wait(10) -- The 10 second delay
        end
    end)
end

-- [[ AUTOMATION TAB ]]
local HopperToggle = Tabs.Automation:AddToggle("HopperToggle", {Title = "Server Hopper (Mesh Detector)", Default = false })

Tabs.Automation:AddButton({
    Title = "Start Hopper",
    Description = "Only needed if you just enabled the toggle manually.",
    Callback = function()
        if HopperToggle.Value then
            startHopperLoop()
        else
            Fluent:Notify({Title = "Error", Content = "Enable the toggle first!", Duration = 3})
        end
    end
})

HopperToggle:OnChanged(function()
    -- Only auto-starts if the script is still in its "loading" phase
    if HopperToggle.Value and not isInitialized then
        startHopperLoop()
    end
end)

-- [[ SETTINGS TAB ]]
Tabs.Settings:AddInput("WebhookURL", {
    Title = "Webhook URL",
    Callback = function(Value) webhookURL = Value end
})

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({"WebhookURL"})
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

Window:SelectTab(1)

-- [[ INITIALIZATION ]]
-- This part handles the "Auto-run if config is ON" logic
task.spawn(function()
    SaveManager:LoadAutoloadConfig()
    task.wait(0.5) -- Wait for config to apply values
    if HopperToggle.Value then
        startHopperLoop()
    end
    isInitialized = true -- After this, turning the toggle ON requires the Start Button
end)
