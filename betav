--[[
    CSMDH meth | V1.1.4
    Professional Devil Heart Automation Utility
    
    Update Log:
    - Replaced VirtualInputManager with getconnections() interceptor for the Play Button.
    - Maintains full compatibility with all existing automation features.
    - NEW: Added Debug section with real-time Studs Per Second (SPS) tracking.
]]

-- [[ PRE-LOAD INTERCEPTOR ]]
-- This section runs before the UI library loads to ensure the player is in-game.
local function handleNativeMainMenu()
    local lp = game:GetService("Players").LocalPlayer
    if not lp then return end
    
    local playerGui = lp:FindFirstChild("PlayerGui")
    if playerGui then
        -- Path provided: .MainMenu.Menu.MainMenu.PlayButton
        local playButton = playerGui:FindFirstChild("MainMenu") 
            and playerGui.MainMenu:FindFirstChild("Menu")
            and playerGui.MainMenu.Menu:FindFirstChild("MainMenu")
            and playerGui.MainMenu.Menu.MainMenu:FindFirstChild("PlayButton")

        if playButton and playButton:IsA("GuiButton") then
            print("[CSMDH] Native Play Button detected. Triggering enter...")
            
            -- Triggering via getconnections for maximum executor compatibility
            local success = false
            if getconnections then
                for _, connection in pairs(getconnections(playButton.MouseButton1Click)) do
                    connection:Fire()
                    success = true
                end
            end
            
            -- Note: If getconnections fails or is unavailable, we do not use .Activate() 
            -- per user instruction to avoid non-existent property errors.
            if success then
                print("[CSMDH] Play Button signals fired successfully.")
            end
        end
    end
end

-- Execute pre-load check immediately
handleNativeMainMenu()

-- [[ MAIN UI INITIALIZATION ]]
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- Constants
local MESH_ID_TARGET = "rbxassetid://12439777368"
local SERVER_LOG_FILE = "fluent_server_history.json"
local LocalPlayer = Players.LocalPlayer
local MIN_Y_LIMIT = 942
local AC_BAIT_Y_LIMIT = 940

-- State Variables
local webhookURL = ""
local webhookEnabled = false
local isInitialized = false 
local activeTweens = {}
local stopRequested = false
local velocityConnection = nil
local isHopperRunning = false

-- Debug Variables
local lastPosition = Vector3.new(0, 0, 0)
local currentSPS = 0

-- [[ HELPER FUNCTIONS ]]

local function findDevilHeart()
    local map = workspace:FindFirstChild("map")
    local rokyos = map and map:FindFirstChild("Rokyo")
    if rokyos then
        for _, object in ipairs(rokyos:GetChildren()) do
            if object:IsA("MeshPart") and object.MeshId == MESH_ID_TARGET then
                if object:FindFirstChildOfClass("PointLight") then 
                    local cf = object.CFrame
                    local pos = Vector3.new(cf.X, cf.Y, cf.Z)
                    
                    if pos.Y < AC_BAIT_Y_LIMIT then
                        return "ACBait", pos
                    end
                    return "valid", pos
                end
            end
        end
    end
    return nil, nil
end

local function sendWebhook(title, message, color)
    if webhookEnabled and webhookURL ~= "" and webhookURL:find("discord.com/api/webhooks") then
        local data = {
            ["embeds"] = {{
                ["title"] = title,
                ["description"] = message,
                ["color"] = color or 0x00ff00,
                ["timestamp"] = DateTime.now():ToIsoDate()
            }}
        }
        pcall(function()
            request({
                Url = webhookURL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(data)
            })
        end)
    end
end

local function getHistory()
    if isfile(SERVER_LOG_FILE) then
        local success, data = pcall(function() return HttpService:JSONDecode(readfile(SERVER_LOG_FILE)) end)
        return success and data or {}
    end
    return {}
end

local function serverHop()
    local history = getHistory()
    if not history then history = {} end
    history[game.JobId] = os.time()
    writefile(SERVER_LOG_FILE, HttpService:JSONEncode(history))

    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    end)

    if success and result and result.data then
        for _, server in ipairs(result.data) do
            if server.playing < server.maxPlayers and not history[server.id] and server.id ~= game.JobId then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

-- [[ MOVEMENT ENGINE ]]

local function stopTween()
    stopRequested = true
    for _, t in ipairs(activeTweens) do
        if t.PlaybackState == Enum.PlaybackState.Playing then t:Cancel() end
    end
    activeTweens = {}
    if velocityConnection then velocityConnection:Disconnect() velocityConnection = nil end
    local character = LocalPlayer.Character
    local humanoid = character and character:FindFirstChildOfClass("Humanoid")
    if humanoid then humanoid:ChangeState(Enum.HumanoidStateType.Landed) end
end

local function performTweenSegment(targetPos)
    if stopRequested then return end
    local character = LocalPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end

    local speed = tonumber(Fluent.Options.TweenSpeed.Value) or 0.5
    local easingStyle = Fluent.Options.TweenEasing.Value
    local distance = (rootPart.Position - targetPos).Magnitude
    local duration = (speed * distance) / 100

    local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle[easingStyle], Enum.EasingDirection.Out)
    local tween = TweenService:Create(rootPart, tweenInfo, {CFrame = CFrame.new(targetPos)})
    
    table.insert(activeTweens, tween)
    tween:Play()
    tween.Completed:Wait()
end

local function startStagedTween(targetPos)
    stopRequested = false
    local character = LocalPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    local humanoid = character and character:FindFirstChildOfClass("Humanoid")
    if not rootPart then return end

    velocityConnection = RunService.Stepped:Connect(function()
        if rootPart and rootPart.Parent then
            rootPart.Velocity = Vector3.new(0, -0.01, 0)
            rootPart.RotVelocity = Vector3.zero
        end
    end)
    if humanoid then humanoid:ChangeState(Enum.HumanoidStateType.Physics) end

    local useSplit = Fluent.Options.SplitToggle.Value
    local useSegments = Fluent.Options.SegmentToggle.Value
    local maxDist = tonumber(Fluent.Options.TweenDist.Value) or 50
    local interval = Fluent.Options.TweenInterval.Value

    local function moveToGoal(goalPos)
        while (rootPart.Position - goalPos).Magnitude > 1 and not stopRequested do
            local currentPos = rootPart.Position
            local dist = (currentPos - goalPos).Magnitude
            local nextStep = (useSegments and dist > maxDist) and (currentPos + (goalPos - currentPos).Unit * maxDist) or goalPos
            
            if nextStep.Y < MIN_Y_LIMIT then nextStep = Vector3.new(nextStep.X, MIN_Y_LIMIT, nextStep.Z) end

            performTweenSegment(nextStep)
            if not stopRequested and useSegments and (rootPart.Position - goalPos).Magnitude > 1 then task.wait(interval) end
        end
    end

    if useSplit then
        local horizGoal = Vector3.new(targetPos.X, math.max(rootPart.Position.Y, MIN_Y_LIMIT), targetPos.Z)
        moveToGoal(horizGoal)
        if not stopRequested then moveToGoal(targetPos) end
    else
        moveToGoal(targetPos)
    end
    stopTween()
end

-- [[ CORE HOPPER LOOP ]]

local function runHopperLogic()
    if isHopperRunning then return end
    isHopperRunning = true
    
    task.spawn(function()
        while Fluent.Options.HopperToggle.Value do
            local status, heartPos = findDevilHeart()
            
            if status == "ACBait" then
                sendWebhook("⚠️ ACBait Detected", "Ignoring trap heart at Y: " .. heartPos.Y .. " in server: " .. game.JobId, 0xff0000)
                serverHop()
            elseif status == "valid" then
                sendWebhook("✅ Valid Heart Found!", "Target detected in server: " .. game.JobId)
                
                if Fluent.Options.AutoTweenOnFind.Value then
                    Fluent:Notify({Title = "Auto-Discovery", Content = "Starting automatic tween to Heart..."})
                    startStagedTween(heartPos)
                else
                    Fluent:Notify({Title = "Discovery", Content = "Heart found. Auto-Tween is disabled."})
                end
                
                Fluent.Options.HopperToggle:SetValue(false)
                break
            else
                serverHop()
            end
            task.wait(10)
        end
        isHopperRunning = false
    end)
end

-- [[ UI ]]

local Window = Fluent:CreateWindow({
    Title = "CSMDH meth",
    SubTitle = "V1.1.4",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark"
})

local Tabs = {
    Automation = Window:AddTab({ Title = "Automation", Icon = "play" }),
    Settings = Window:AddTab({ Title = "Configuration", Icon = "settings" }),
    Debug = Window:AddTab({ Title = "Debug", Icon = "terminal" }) -- Added Debug Tab
}

-- Automation
Tabs.Automation:AddSection("Heart Detector")
local HopperToggle = Tabs.Automation:AddToggle("HopperToggle", {Title = "Auto-Hop Loop", Default = false })
HopperToggle:OnChanged(function() if HopperToggle.Value then runHopperLogic() end end)

Tabs.Automation:AddToggle("AutoTweenOnFind", {Title = "Auto-Tween on Discovery", Default = true })

Tabs.Automation:AddButton({
    Title = "Start Hopper Manually",
    Callback = function()
        if not HopperToggle.Value then HopperToggle:SetValue(true) else runHopperLogic() end
    end
})

Tabs.Automation:AddButton({
    Title = "Check Server",
    Callback = function()
        local status, hp = findDevilHeart()
        Fluent:Notify({Title = "Status", Content = status == "ACBait" and "ACBait detected." or (status == "valid" and "Heart found at " .. tostring(hp) or "No heart found.")})
    end
})

Tabs.Automation:AddSection("Movement")
Tabs.Automation:AddButton({Title = "Tween to Heart", Callback = function() 
    local status, hp = findDevilHeart() 
    if status == "valid" then startStagedTween(hp) else Fluent:Notify({Title="Error", Content="Valid heart not found."}) end 
end})
Tabs.Automation:AddButton({Title = "Stop Movement", Callback = stopTween})

-- Settings
Tabs.Settings:AddSection("Tweening")
Tabs.Settings:AddToggle("SplitToggle", {Title = "Split XZ/Y Movement", Default = false})
Tabs.Settings:AddToggle("SegmentToggle", {Title = "Segmented Pathing", Default = false})
Tabs.Settings:AddInput("TweenSpeed", {Title = "Speed", Default = "0.5", Numeric = true})
Tabs.Settings:AddInput("TweenDist", {Title = "Max Segment Distance", Default = "50", Numeric = true})
Tabs.Settings:AddSlider("TweenInterval", {Title = "Interval", Default = 2, Min = 0.1, Max = 10, Rounding = 1})
Tabs.Settings:AddDropdown("TweenEasing", {Title = "Easing", Values = {"Linear", "Quad", "Sine", "Cubic"}, Default = "Linear"})

Tabs.Settings:AddSection("Discord")
Tabs.Settings:AddInput("WebhookURL", {Title = "Webhook URL", Default = "", Callback = function(v) webhookURL = v end})
Tabs.Settings:AddToggle("WebhookEnable", {Title = "Enable", Default = false }):OnChanged(function(v) webhookEnabled = v end)

-- Debug Section
Tabs.Debug:AddSection("Performance Tracking")
local SpeedLabel = Tabs.Debug:AddParagraph({
    Title = "Current Speed",
    Content = "Studs Per Second: 0"
})

-- Speed Tracking Logic
RunService.Heartbeat:Connect(function(dt)
    local char = LocalPlayer.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    
    if root then
        local currentPos = root.Position
        local distance = (currentPos - lastPosition).Magnitude
        currentSPS = distance / dt
        
        -- Round for cleaner UI
        local displaySPS = math.floor(currentSPS * 100) / 100
        SpeedLabel:SetTitle("Current Speed")
        SpeedLabel:SetValues({
            Content = "Studs Per Second: " .. tostring(displaySPS)
        })
        
        lastPosition = currentPos
    else
        SpeedLabel:SetValues({
            Content = "Studs Per Second: N/A (No RootPart)"
        })
    end
end)

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({"WebhookURL", "TweenSpeed", "TweenDist", "TweenInterval", "TweenEasing"}) 
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()
task.wait(0.5)
isInitialized = true

if HopperToggle.Value then runHopperLogic() end
