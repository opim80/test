--[[
    CSMDH meth | V1.1.7
    Professional Devil Heart Automation Utility
    
    Update Log:
    - Added STPS (Studs Per Second) constant speed mode.
    - Added Ground-Following logic (stays 3 studs above floor).
    - Fixed Segment Floating: Players now fall naturally during intervals.
    - Added Anti-Stuck: Tweens won't end inside parts/meshes.
]]

-- [[ PRE-LOAD INTERCEPTOR ]]
local function handleNativeMainMenu()
    local lp = game:GetService("Players").LocalPlayer
    if not lp then return end
    
    local playerGui = lp:FindFirstChild("PlayerGui")
    if playerGui then
        local playButton = playerGui:FindFirstChild("MainMenu") 
            and playerGui.MainMenu:FindFirstChild("Menu")
            and playerGui.MainMenu.Menu:FindFirstChild("MainMenu")
            and playerGui.MainMenu.Menu.MainMenu:FindFirstChild("PlayButton")

        if playButton and playButton:IsA("GuiButton") then
            if getconnections then
                for _, connection in pairs(getconnections(playButton.MouseButton1Click)) do
                    connection:Fire()
                end
            end
        end
    end
end

handleNativeMainMenu()

-- [[ MAIN UI INITIALIZATION ]]
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- Constants
local MESH_ID_TARGET = "rbxassetid://12439777368"
local SERVER_LOG_FILE = "fluent_server_history.json"
local LocalPlayer = Players.LocalPlayer
local MIN_Y_LIMIT = 942
local AC_BAIT_Y_LIMIT = 940

-- State Variables
local webhookURL = ""
local webhookEnabled = false
local isInitialized = false 
local activeTweens = {}
local stopRequested = false
local velocityConnection = nil
local isHopperRunning = false

-- UI Elements
local StatusLabel = nil
local SpeedLabel = nil 

-- [[ HELPER FUNCTIONS ]]

local function updateStatus(text)
    if StatusLabel then
        StatusLabel:SetTitle("Status: " .. text)
    end
end

-- Checks if the player is inside any part/mesh
local function isInsideObject(pos)
    local region = Region3.new(pos - Vector3.new(1,1,1), pos + Vector3.new(1,1,1))
    local parts = workspace:FindPartsInRegion3(region, LocalPlayer.Character, 10)
    for _, part in ipairs(parts) do
        if part.CanCollide then return true end
    end
    return false
end

-- Ground following logic
local function getGroundY(currentPos)
    local rayParam = RaycastParams.new()
    rayParam.FilterDescendantsInstances = {LocalPlayer.Character}
    rayParam.FilterType = Enum.RaycastFilterType.Exclude

    local result = workspace:Raycast(currentPos + Vector3.new(0, 5, 0), Vector3.new(0, -500, 0), rayParam)
    if result then
        return result.Position.Y + 3
    end
    return currentPos.Y
end

local function findDevilHeart()
    updateStatus("Scanning for heart...")
    local map = workspace:FindFirstChild("map")
    local rokyos = map and map:FindFirstChild("Rokyo")
    if rokyos then
        for _, object in ipairs(rokyos:GetChildren()) do
            if object:IsA("MeshPart") and object.MeshId == MESH_ID_TARGET then
                if object:FindFirstChildOfClass("PointLight") then 
                    local pos = object.Position
                    if pos.Y < AC_BAIT_Y_LIMIT then return "ACBait", pos end
                    return "valid", pos
                end
            end
        end
    end
    return nil, nil
end

local function sendWebhook(title, message, color)
    if webhookEnabled and webhookURL ~= "" and webhookURL:find("discord.com/api/webhooks") then
        local data = {
            ["embeds"] = {{
                ["title"] = title,
                ["description"] = message,
                ["color"] = color or 0x00ff00,
                ["timestamp"] = DateTime.now():ToIsoDate()
            }}
        }
        pcall(function()
            request({
                Url = webhookURL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(data)
            })
        end)
    end
end

local function serverHop()
    updateStatus("Preparing to hop...")
    local history = isfile(SERVER_LOG_FILE) and HttpService:JSONDecode(readfile(SERVER_LOG_FILE)) or {}
    history[game.JobId] = os.time()
    writefile(SERVER_LOG_FILE, HttpService:JSONEncode(history))

    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    end)

    if success and result and result.data then
        for _, server in ipairs(result.data) do
            if server.playing < server.maxPlayers and not history[server.id] and server.id ~= game.JobId then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

-- [[ MOVEMENT ENGINE ]]

local function stopTween()
    stopRequested = true
    for _, t in ipairs(activeTweens) do
        if t.PlaybackState == Enum.PlaybackState.Playing then t:Cancel() end
    end
    activeTweens = {}
    if velocityConnection then velocityConnection:Disconnect() velocityConnection = nil end
    local character = LocalPlayer.Character
    local humanoid = character and character:FindFirstChildOfClass("Humanoid")
    if humanoid then 
        humanoid:ChangeState(Enum.HumanoidStateType.Landed) 
    end
    updateStatus("Movement stopped.")
end

local function performTweenSegment(targetPos)
    if stopRequested then return end
    local character = LocalPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end

    -- Ground Following Adjustment
    if Fluent.Options.GroundOnly.Value then
        local groundY = getGroundY(targetPos)
        targetPos = Vector3.new(targetPos.X, groundY, targetPos.Z)
    end

    local distance = (rootPart.Position - targetPos).Magnitude
    local duration = 0
    
    -- Speed Mode Selection
    if Fluent.Options.SpeedMode.Value == "STPS (Constant)" then
        local stps = tonumber(Fluent.Options.TweenSTPS.Value) or 30
        duration = distance / stps
    else
        local speed = tonumber(Fluent.Options.TweenSpeed.Value) or 0.5
        duration = (speed * distance) / 100
    end

    local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle[Fluent.Options.TweenEasing.Value], Enum.EasingDirection.Out)
    local tween = TweenService:Create(rootPart, tweenInfo, {CFrame = CFrame.new(targetPos)})
    
    table.insert(activeTweens, tween)
    tween:Play()
    tween.Completed:Wait()

    -- Anti-Stuck Check
    while isInsideObject(rootPart.Position) and not stopRequested do
        updateStatus("Anti-Stuck: Adjusting...")
        rootPart.CFrame = rootPart.CFrame * CFrame.new(0, 2, 0)
        task.wait(0.1)
    end
end

local function startStagedTween(targetPos)
    updateStatus("Initiating Tween...")
    stopRequested = false
    local character = LocalPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    local humanoid = character and character:FindFirstChildOfClass("Humanoid")
    if not rootPart then return end

    local function setNoVelocity()
        if velocityConnection then velocityConnection:Disconnect() end
        velocityConnection = RunService.Stepped:Connect(function()
            if rootPart and rootPart.Parent then
                rootPart.Velocity = Vector3.new(0, -0.01, 0)
                rootPart.RotVelocity = Vector3.zero
            end
        end)
    end

    local function moveToGoal(goalPos, label)
        while (rootPart.Position - goalPos).Magnitude > 2 and not stopRequested do
            setNoVelocity()
            if humanoid then humanoid:ChangeState(Enum.HumanoidStateType.Physics) end
            
            updateStatus("Moving " .. label .. "...")
            local currentPos = rootPart.Position
            local dist = (currentPos - goalPos).Magnitude
            
            local segmentDist = tonumber(Fluent.Options.TweenDist.Value) or 50
            local nextStep = (Fluent.Options.SegmentToggle.Value and dist > segmentDist) 
                and (currentPos + (goalPos - currentPos).Unit * segmentDist) or goalPos
            
            if nextStep.Y < MIN_Y_LIMIT and not Fluent.Options.GroundOnly.Value then 
                nextStep = Vector3.new(nextStep.X, MIN_Y_LIMIT, nextStep.Z) 
            end
            
            performTweenSegment(nextStep)
            
            -- Segment Interval handling (Falling)
            if not stopRequested and Fluent.Options.SegmentToggle.Value and (rootPart.Position - goalPos).Magnitude > 2 then 
                if velocityConnection then velocityConnection:Disconnect() velocityConnection = nil end
                if humanoid then humanoid:ChangeState(Enum.HumanoidStateType.Falling) end
                
                updateStatus("Segment Wait (Gravity Active)...")
                task.wait(Fluent.Options.TweenInterval.Value) 
            end
        end
    end

    if Fluent.Options.SplitToggle.Value then
        moveToGoal(Vector3.new(targetPos.X, math.max(rootPart.Position.Y, MIN_Y_LIMIT), targetPos.Z), "Horizontally")
        if not stopRequested then moveToGoal(targetPos, "Vertically") end
    else
        moveToGoal(targetPos, "to Target")
    end
    
    updateStatus("Reached destination.")
    stopTween()
end

-- [[ CORE HOPPER LOOP ]]

local function runHopperLogic()
    if isHopperRunning then return end
    isHopperRunning = true
    
    task.spawn(function()
        while Fluent.Options.HopperToggle.Value do
            local status, heartPos = findDevilHeart()
            if status == "ACBait" then
                sendWebhook("⚠️ ACBait Detected", "Ignoring heart at Y: " .. heartPos.Y, 0xff0000)
                serverHop()
            elseif status == "valid" then
                sendWebhook("✅ Valid Heart Found!", "Target in server: " .. game.JobId)
                if Fluent.Options.AutoTweenOnFind.Value then startStagedTween(heartPos) end
                Fluent.Options.HopperToggle:SetValue(false)
                break
            else
                serverHop()
            end
            task.wait(10)
        end
        isHopperRunning = false
    end)
end

-- [[ UI INITIALIZATION ]]

local Window = Fluent:CreateWindow({
    Title = "CSMDH meth",
    SubTitle = "V1.1.7",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 520),
    Acrylic = true, 
    Theme = "Dark"
})

local Tabs = {
    Automation = Window:AddTab({ Title = "Automation", Icon = "play" }),
    Debug = Window:AddTab({ Title = "Debug", Icon = "bug" }),
    Settings = Window:AddTab({ Title = "Configuration", Icon = "settings" })
}

StatusLabel = Tabs.Automation:AddParagraph({ Title = "Status: Idle", Content = "Awaiting instructions." })

Tabs.Automation:AddSection("Heart Detector")
local HopperToggle = Tabs.Automation:AddToggle("HopperToggle", {Title = "Auto-Hop Loop", Default = false })
Tabs.Automation:AddToggle("AutoTweenOnFind", {Title = "Auto-Tween on Discovery", Default = true })
Tabs.Automation:AddButton({ Title = "Start Hopper", Callback = runHopperLogic })

Tabs.Automation:AddSection("Manual Actions")
Tabs.Automation:AddButton({Title = "Tween to Heart", Callback = function() 
    local status, hp = findDevilHeart() 
    if status == "valid" then startStagedTween(hp) end 
end})
Tabs.Automation:AddButton({Title = "Stop Movement", Callback = stopTween})

-- Debug Tab
Tabs.Debug:AddSection("Live Statistics")
SpeedLabel = Tabs.Debug:AddParagraph({ Title = "Studs Per Second: 0", Content = "Real-time velocity." })

-- Configuration Tab
Tabs.Settings:AddSection("Movement Modes")
Tabs.Settings:AddDropdown("SpeedMode", {Title = "Speed Method", Values = {"Classic (Time Multiplier)", "STPS (Constant)"}, Default = "STPS (Constant)"})
Tabs.Settings:AddInput("TweenSTPS", {Title = "Constant STPS", Default = "30", Numeric = true})
Tabs.Settings:AddInput("TweenSpeed", {Title = "Classic Speed Multiplier", Default = "0.5", Numeric = true})
Tabs.Settings:AddToggle("GroundOnly", {Title = "Ground Only Mode (Stay +3 Studs)", Default = false})

Tabs.Settings:AddSection("Segmentation & Split")
Tabs.Settings:AddToggle("SplitToggle", {Title = "Split XZ/Y", Default = false})
Tabs.Settings:AddToggle("SegmentToggle", {Title = "Segments", Default = false})
Tabs.Settings:AddInput("TweenDist", {Title = "Segment Distance", Default = "50", Numeric = true})
Tabs.Settings:AddSlider("TweenInterval", {Title = "Segment Interval", Default = 2, Min = 0.1, Max = 10, Rounding = 1})
Tabs.Settings:AddDropdown("TweenEasing", {Title = "Easing", Values = {"Linear", "Quad", "Sine", "Cubic"}, Default = "Linear"})

Tabs.Settings:AddSection("Discord Notifications")
Tabs.Settings:AddInput("WebhookURL", {Title = "URL", Default = "", Callback = function(v) webhookURL = v end})
Tabs.Settings:AddToggle("WebhookEnable", {Title = "Enable", Default = false }):OnChanged(function(v) webhookEnabled = v end)

-- [[ SPEED TRACKING LOGIC ]]
RunService.Heartbeat:Connect(function()
    if SpeedLabel and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local sps = math.floor(LocalPlayer.Character.HumanoidRootPart.Velocity.Magnitude + 0.5)
        SpeedLabel:SetTitle("Studs Per Second: " .. tostring(sps))
    end
end)

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()

updateStatus("V1.1.7 Ready")
