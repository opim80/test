local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")

-- Constants
local MESH_ID_TARGET = "rbxassetid://12439777368"
local SERVER_LOG_FILE = "fluent_server_history.json"

-- State Variables
local webhookURL = ""
local webhookEnabled = false
local isInitialized = false 

-- Helper: Find Devil Heart
local function findDevilHeart()
    local map = workspace:FindFirstChild("map")
    local rokyos = map and map:FindFirstChild("Rokyo")
    if rokyos then
        for _, object in ipairs(rokyos:GetChildren()) do
            if object:IsA("MeshPart") and object.MeshId == MESH_ID_TARGET then
                if object:FindFirstChildOfClass("PointLight") then return object end
            end
        end
    end
    return nil
end

-- Helper: Find Ground Position
local function getGroundBelow(pos)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = {game.Players.LocalPlayer.Character}
    
    -- Cast ray downwards 500 studs
    local result = workspace:Raycast(pos, Vector3.new(0, -500, 0), raycastParams)
    if result then
        return result.Position + Vector3.new(0, 3, 0) -- Stay 3 studs above hit point
    end
    return pos -- Fallback if no ground found
end

-- Helper: Incremental Tween Movement
local function tweenToHeart(targetPart)
    local character = game.Players.LocalPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end

    local speed = tonumber(Fluent.Options.TweenSpeed.Value) or 0.5
    local easingStyle = Fluent.Options.TweenEasing.Value
    local targetPos = targetPart.Position

    task.spawn(function()
        while (rootPart.Position - targetPos).Magnitude > 5 do
            local currentPos = rootPart.Position
            local direction = (targetPos - currentPos).Unit
            local distanceToTravel = math.min(50, (targetPos - currentPos).Magnitude)
            local nextDestination = currentPos + (direction * distanceToTravel)

            -- If we are at the end, go to heart, otherwise find ground
            local landingPoint = nextDestination
            if (targetPos - nextDestination).Magnitude > 5 then
                landingPoint = getGroundBelow(nextDestination)
            else
                landingPoint = targetPart.Position
            end

            -- Calculate Duration (Lower number = Faster)
            local segDist = (rootPart.Position - landingPoint).Magnitude
            local duration = (speed * segDist) / 100

            local tween = TweenService:Create(rootPart, TweenInfo.new(duration, Enum.EasingStyle[easingStyle]), {CFrame = CFrame.new(landingPoint)})
            tween:Play()
            tween.Completed:Wait()

            -- Ground Pause (unless we are at the heart)
            if (rootPart.Position - targetPos).Magnitude > 5 then
                Fluent:Notify({Title = "Movement", Content = "Resting on ground for 4s...", Duration = 2})
                task.wait(4)
            end
        end
        Fluent:Notify({Title = "Success", Content = "Reached Devil Heart!", Duration = 5})
    end)
end

-- [The rest of the ServerHop, Webhook, and UI Logic from the previous script remains identical]

-- Create Window
local Window = Fluent:CreateWindow({
    Title = "Devil Heart Utility",
    SubTitle = "Safe Tween Edition",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Automation = Window:AddTab({ Title = "Automation", Icon = "play" }),
    Settings = Window:AddTab({ Title = "Config & Webhooks", Icon = "settings" })
}

-- [[ AUTOMATION TAB ]]
Tabs.Automation:AddSection("Devil Heart Detector")
local HopperToggle = Tabs.Automation:AddToggle("HopperToggle", {Title = "Devil Heart Hopper", Default = false })

Tabs.Automation:AddButton({
    Title = "Start Hopper",
    Callback = function()
        if HopperToggle.Value then
            task.spawn(function()
                while Fluent.Options.HopperToggle.Value do
                    local heart = findDevilHeart()
                    if heart then
                        HopperToggle:SetValue(false)
                        tweenToHeart(heart)
                        break
                    else
                        -- Call your serverHop function here
                    end
                    task.wait(10)
                end
            end)
        end
    end
})

Tabs.Automation:AddSection("Movement Settings")
Tabs.Automation:AddInput("TweenSpeed", {Title = "Tween Speed", Default = "0.5", Numeric = true})
Tabs.Automation:AddDropdown("TweenEasing", {Title = "Easing Style", Values = {"Linear", "Quad", "Sine"}, Default = "Linear"})

Tabs.Automation:AddButton({
    Title = "Tween to Heart",
    Description = "Moves 50 studs then rests on ground",
    Callback = function()
        local heart = findDevilHeart()
        if heart then tweenToHeart(heart) end
    end
})

-- [[ CONFIG MANAGEMENT ]]
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()
task.wait(0.5)
isInitialized = true
