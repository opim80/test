local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- Constants
local MESH_ID_TARGET = "rbxassetid://12439777368"
local LocalPlayer = Players.LocalPlayer

-- State Variables
local activeMovement = false
local avoidanceDirection = 1 -- 1 for Right, -1 for Left

-- Helper: Find Devil Heart
local function findDevilHeart()
    local map = workspace:FindFirstChild("map")
    local rokyos = map and map:FindFirstChild("Rokyo")
    if rokyos then
        for _, object in ipairs(rokyos:GetChildren()) do
            if object:IsA("MeshPart") and object.MeshId == MESH_ID_TARGET then
                if object:FindFirstChildOfClass("PointLight") then return object end
            end
        end
    end
    return nil
end

-- Helper: Visualize Ray
local function createVisualRay(pos, dir, color)
    local p = Instance.new("Part")
    p.Anchored = true
    p.CanCollide = false
    p.Size = Vector3.new(0.2, 0.2, dir.Magnitude)
    p.CFrame = CFrame.lookAt(pos + dir/2, pos + dir)
    p.Color = color
    p.Material = Enum.Material.Neon
    p.Parent = workspace:FindFirstChild("RayVisuals") or (function()
        local f = Instance.new("Folder", workspace)
        f.Name = "RayVisuals"
        return f
    end)()
    task.delay(0.1, function() p:Destroy() end)
end

-- Reactive Movement Logic
local function reactiveMove(targetPart)
    activeMovement = true
    local character = LocalPlayer.Character
    local root = character:WaitForChild("HumanoidRootPart")
    local humanoid = character:WaitForChild("Humanoid")
    
    while activeMovement and targetPart and targetPart.Parent do
        local startPos = root.Position
        local targetPos = targetPart.Position
        local toTarget = (targetPos - startPos).Unit
        
        -- Raycast to detect wall in front
        local rayParams = RaycastParams.new()
        rayParams.FilterType = Enum.RaycastFilterType.Exclude
        rayParams.FilterDescendantsInstances = {character}
        
        -- Detect wall face-first (look ahead 7 studs)
        local result = workspace:Raycast(startPos, toTarget * 7, rayParams)
        createVisualRay(startPos, toTarget * 7, result and Color3.new(1,0,0) or Color3.new(0,1,0))

        if result and result.Instance.CanCollide then
            -- We hit a wall!
            -- Calculate a direction to walk ALONG the wall
            local wallNormal = result.Normal
            local walkDir = Vector3.new(-wallNormal.Z, 0, wallNormal.X) * avoidanceDirection
            
            -- Jump if the wall is short or we are stuck
            if result.Distance < 3 then
                humanoid.Jump = true
            end
            
            -- Move sideways until the wall is gone
            humanoid:Move(walkDir, false)
        else
            -- Path is clear, move toward heart
            humanoid:Move(toTarget, false)
        end
        
        -- Stop if we are close enough
        if (targetPos - startPos).Magnitude < 5 then
            activeMovement = false
            break
        end
        
        task.wait()
    end
end

-- Create Window
local Window = Fluent:CreateWindow({
    Title = "Devil Heart Utility v6.0",
    SubTitle = "Reactive Avoidance",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Automation = Window:AddTab({ Title = "Automation", Icon = "play" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- [[ AUTOMATION TAB ]]
Tabs.Automation:AddSection("Reactive Movement")

Tabs.Automation:AddButton({
    Title = "Start Reactive Walk",
    Description = "Walks to heart and navigates around walls on contact",
    Callback = function()
        local heart = findDevilHeart()
        if heart then
            reactiveMove(heart)
        else
            Fluent:Notify({Title = "Error", Content = "Devil Heart not found.", Duration = 3})
        end
    end
})

Tabs.Automation:AddButton({
    Title = "Stop Movement",
    Callback = function() activeMovement = false end
})

Tabs.Automation:AddDropdown("AvoidSide", {
    Title = "Avoidance Direction",
    Description = "Which side to prioritize when hitting a wall.",
    Values = {"Left", "Right"},
    Default = "Right",
    Callback = function(Value)
        avoidanceDirection = (Value == "Right" and 1 or -1)
    end
})

Tabs.Automation:AddParagraph({
    Title = "How it works",
    Content = "The player walks toward the heart. If a red line (Raycast) hits a wall, the player will start strafing sideways until the line turns green (path clear), then continues forward."
})

-- [[ INITIALIZATION ]]
Window:SelectTab(1)
SaveManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
SaveManager:LoadAutoloadConfig()
isInitialized = true
