local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

-- Constants
local MESH_ID_TARGET = "rbxassetid://12439777368"
local SERVER_LOG_FILE = "fluent_server_history.json"

-- Helper: Find Devil Heart
local function findDevilHeart()
    local map = workspace:FindFirstChild("map")
    local rokyos = map and map:FindFirstChild("Rokyo")
    if rokyos then
        for _, object in ipairs(rokyos:GetChildren()) do
            if object:IsA("MeshPart") and object.MeshId == MESH_ID_TARGET then
                if object:FindFirstChildOfClass("PointLight") then return object end
            end
        end
    end
    return nil
end

-- Stealth Tween Logic (IY Inspired)
local function tweenToHeart(targetPart)
    local character = game.Players.LocalPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    local humanoid = character and character:FindFirstChild("Humanoid")
    if not rootPart or not humanoid then return end

    local speed = tonumber(Fluent.Options.TweenSpeed.Value) or 0.5
    local easingStyle = Fluent.Options.TweenEasing.Value
    local distance = (rootPart.Position - targetPart.Position).Magnitude
    local duration = (speed * distance) / 100

    -- [IY Stealth Step 1]: Change State to prevent physics interference
    humanoid:ChangeState(Enum.HumanoidStateType.Physics)
    
    -- [IY Stealth Step 2]: Zero out velocity during move
    local velConnection = RunService.Stepped:Connect(function()
        for _, v in pairs(character:GetDescendants()) do
            if v:IsA("BasePart") then
                v.Velocity = Vector3.new(0, 0, 0)
                v.RotVelocity = Vector3.new(0, 0, 0)
            end
        end
    end)

    local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle[easingStyle], Enum.EasingDirection.Out)
    local tween = TweenService:Create(rootPart, tweenInfo, {CFrame = targetPart.CFrame})
    
    tween:Play()
    tween.Completed:Wait()
    
    -- Cleanup
    velConnection:Disconnect()
    humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
end

-- Create Window
local Window = Fluent:CreateWindow({
    Title = "Devil Heart Utility (Stealth)",
    SubTitle = "v4.2 - IY Logic Applied",
    TabWidth = 160, Size = UDim2.fromOffset(580, 460), Acrylic = true, Theme = "Dark", MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Automation = Window:AddTab({ Title = "Automation", Icon = "play" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- [[ AUTOMATION TAB ]]
Tabs.Automation:AddSection("Devil Heart Detector")

local HopperToggle = Tabs.Automation:AddToggle("HopperToggle", {Title = "Devil Heart Hopper", Default = false })

Tabs.Automation:AddButton({
    Title = "Start Hopper",
    Callback = function()
        if HopperToggle.Value then
            task.spawn(function()
                while HopperToggle.Value do
                    local heart = findDevilHeart()
                    if heart then
                        Fluent:Notify({Title = "Success", Content = "Heart Found! Moving...", Duration = 10})
                        tweenToHeart(heart)
                        HopperToggle:SetValue(false)
                        break
                    else
                        -- Server hop logic here
                    end
                    task.wait(10)
                end
            end)
        end
    end
})

Tabs.Automation:AddSection("Movement Settings")

Tabs.Automation:AddInput("TweenSpeed", { Title = "Tween Speed", Default = "0.5", Numeric = true, Callback = function() end })
Tabs.Automation:AddDropdown("TweenEasing", { Title = "Easing Style", Values = {"Linear", "Quad", "Sine"}, Default = "Linear", Callback = function() end })

Tabs.Automation:AddButton({
    Title = "Tween to Heart",
    Callback = function()
        local heart = findDevilHeart()
        if heart then tweenToHeart(heart) else Fluent:Notify({Title = "Error", Content = "No Heart found.", Duration = 3}) end
    end
})

Window:SelectTab(1)
