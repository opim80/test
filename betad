local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- Constants
local MESH_ID_TARGET = "rbxassetid://12439777368"
local SERVER_LOG_FILE = "fluent_server_history.json"
local LocalPlayer = Players.LocalPlayer
local MIN_Y_LIMIT = 942

-- State Variables
local isInitialized = false 
local activeTweens = {} -- Store multiple segments
local stopRequested = false
local velocityConnection = nil

-- Helper: Find Devil Heart
local function findDevilHeart()
    local map = workspace:FindFirstChild("map")
    local rokyos = map and map:FindFirstChild("Rokyo")
    if rokyos then
        for _, object in ipairs(rokyos:GetChildren()) do
            if object:IsA("MeshPart") and object.MeshId == MESH_ID_TARGET then
                if object:FindFirstChildOfClass("PointLight") then return object end
            end
        end
    end
    return nil
end

-- Improved Stop Logic
local function stopTween()
    stopRequested = true
    for _, t in ipairs(activeTweens) do
        if t.PlaybackState == Enum.PlaybackState.Playing then
            t:Cancel()
        end
    end
    activeTweens = {}
    if velocityConnection then velocityConnection:Disconnect() velocityConnection = nil end
    
    local character = LocalPlayer.Character
    local humanoid = character and character:FindFirstChildOfClass("Humanoid")
    if humanoid then humanoid:ChangeState(Enum.HumanoidStateType.Landed) end
end

-- Helper: Perform Single Segment
local function performTweenSegment(targetCFrame)
    if stopRequested then return end
    local character = LocalPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end

    local speed = tonumber(Fluent.Options.TweenSpeed.Value) or 0.5
    local easingStyle = Fluent.Options.TweenEasing.Value
    local distance = (rootPart.Position - targetCFrame.Position).Magnitude
    local duration = (speed * distance) / 100

    local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle[easingStyle], Enum.EasingDirection.Out)
    local tween = TweenService:Create(rootPart, tweenInfo, {CFrame = targetCFrame})
    
    table.insert(activeTweens, tween)
    tween:Play()
    tween.Completed:Wait()
end

-- Master Movement
local function startStagedTween(targetPart)
    stopRequested = false
    local character = LocalPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    local humanoid = character and character:FindFirstChildOfClass("Humanoid")
    if not rootPart then return end

    -- IY Safety + Spoofing
    velocityConnection = RunService.Stepped:Connect(function()
        if rootPart and rootPart.Parent then
            rootPart.Velocity = Vector3.new(0, -0.01, 0) -- Tiny gravity spoof
            rootPart.RotVelocity = Vector3.zero
        end
    end)
    if humanoid then humanoid:ChangeState(Enum.HumanoidStateType.Physics) end

    local targetPos = targetPart.Position
    local useSplit = Fluent.Options.SplitToggle.Value -- XZ then Y logic
    local useSegments = Fluent.Options.SegmentToggle.Value -- Stud limit logic
    local maxDist = tonumber(Fluent.Options.TweenDist.Value) or 50
    local interval = Fluent.Options.TweenInterval.Value

    local function moveToGoal(goalPos)
        while (rootPart.Position - goalPos).Magnitude > 1 and not stopRequested do
            local currentPos = rootPart.Position
            local dist = (currentPos - goalPos).Magnitude
            
            local nextStep
            if useSegments and dist > maxDist then
                nextStep = currentPos + (goalPos - currentPos).Unit * maxDist
            else
                nextStep = goalPos
            end
            
            -- Height Guard
            if nextStep.Y < MIN_Y_LIMIT then
                nextStep = Vector3.new(nextStep.X, MIN_Y_LIMIT, nextStep.Z)
            end

            performTweenSegment(CFrame.new(nextStep))
            if useSegments and (rootPart.Position - goalPos).Magnitude > 1 then
                task.wait(interval)
            end
        end
    end

    if useSplit then
        -- Horizontal Phase
        local horizGoal = Vector3.new(targetPos.X, math.max(rootPart.Position.Y, MIN_Y_LIMIT), targetPos.Z)
        moveToGoal(horizGoal)
        -- Vertical Phase
        if not stopRequested then moveToGoal(targetPos) end
    else
        -- Direct Path (with segmenting if enabled)
        moveToGoal(targetPos)
    end

    stopTween()
end

-- UI
local Window = Fluent:CreateWindow({
    Title = "CSMDH meth",
    SubTitle = "V1.0.0",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark"
})

local Tabs = {
    Automation = Window:AddTab({ Title = "Automation", Icon = "play" }),
    Settings = Window:AddTab({ Title = "Configuration", Icon = "settings" })
}

-- [[ AUTOMATION TAB ]]
Tabs.Automation:AddSection("Devil Heart")
local HopperToggle = Tabs.Automation:AddToggle("HopperToggle", {Title = "Auto-Hop Loop", Default = false })

Tabs.Automation:AddButton({
    Title = "Tween to Heart",
    Callback = function()
        local heart = findDevilHeart()
        if heart then startStagedTween(heart) else Fluent:Notify({Title = "Error", Content = "No heart found."}) end
    end
})

Tabs.Automation:AddButton({
    Title = "Stop Tween",
    Callback = stopTween
})

-- [[ CONFIGURATION TAB ]]
Tabs.Settings:AddSection("Logic Toggles")
Tabs.Settings:AddToggle("SplitToggle", {Title = "Split XZ and Y Movement", Default = true})
Tabs.Settings:AddToggle("SegmentToggle", {Title = "Use Segmented Stud Distance", Default = true})

Tabs.Settings:AddSection("Tween Parameters")
Tabs.Settings:AddInput("TweenSpeed", {Title = "Speed (Lower=Faster)", Default = "0.5", Numeric = true})
Tabs.Settings:AddInput("TweenDist", {Title = "Studs per Segment", Default = "50", Numeric = true})
Tabs.Settings:AddSlider("TweenInterval", {Title = "Wait Interval (s)", Default = 2, Min = 0.1, Max = 60, Rounding = 1})
Tabs.Settings:AddDropdown("TweenEasing", {Title = "Easing Style", Values = {"Linear", "Quad", "Sine", "Cubic"}, Default = "Linear"})

-- [[ WEBHOOKS & UTILITY ]]
-- (Anti-AFK and Webhook code remains the same as previous version)

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

Window:SelectTab(1)
