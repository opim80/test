local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- Constants
local MESH_ID_TARGET = "rbxassetid://12439777368"
local SERVER_LOG_FILE = "fluent_server_history.json"
local LocalPlayer = Players.LocalPlayer
local MIN_Y_LIMIT = 942

-- State Variables
local webhookURL = ""
local webhookEnabled = false
local isInitialized = false 
local activeTween = nil
local velocityConnection = nil
local floorCheckConnection = nil

-- Helper: Find Devil Heart
local function findDevilHeart()
    local map = workspace:FindFirstChild("map")
    local rokyos = map and map:FindFirstChild("Rokyo")
    
    if rokyos then
        for _, object in ipairs(rokyos:GetChildren()) do
            if object:IsA("MeshPart") and object.MeshId == MESH_ID_TARGET then
                if object:FindFirstChildOfClass("PointLight") then
                    return object
                end
            end
        end
    end
    return nil
end

-- Helper: Stop Active Tween
local function stopTween()
    if activeTween then
        activeTween:Cancel()
        activeTween = nil
    end
    if velocityConnection then
        velocityConnection:Disconnect()
        velocityConnection = nil
    end
    local character = LocalPlayer.Character
    local humanoid = character and character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid:ChangeState(Enum.HumanoidStateType.Landed)
    end
end

-- Safety: Floor Check (Ensures player never falls below 942)
local function startFloorCheck()
    if floorCheckConnection then floorCheckConnection:Disconnect() end
    floorCheckConnection = RunService.Heartbeat:Connect(function()
        local character = LocalPlayer.Character
        local rootPart = character and character:FindFirstChild("HumanoidRootPart")
        if rootPart and rootPart.Position.Y < MIN_Y_LIMIT then
            rootPart.Velocity = Vector3.new(rootPart.Velocity.X, 0, rootPart.Velocity.Z)
            rootPart.CFrame = CFrame.new(rootPart.Position.X, MIN_Y_LIMIT, rootPart.Position.Z)
        end
    end)
end

-- Helper: Tween Movement (Two-Stage IY Stealth)
local function tweenToHeart(targetPart)
    stopTween()
    
    local character = LocalPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    local humanoid = character and character:FindFirstChildOfClass("Humanoid")
    if not rootPart then return end

    local speed = tonumber(Fluent.Options.TweenSpeed.Value) or 0.5
    local easingStyle = Fluent.Options.TweenEasing.Value
    
    -- Stealth setup
    velocityConnection = RunService.Stepped:Connect(function()
        if rootPart and rootPart.Parent then
            rootPart.Velocity = Vector3.zero
            rootPart.RotVelocity = Vector3.zero
        end
    end)
    if humanoid then humanoid:ChangeState(Enum.HumanoidStateType.Physics) end

    -- STAGE 1: Horizontal Movement (X, Z)
    -- We keep the Y level the same as our current Y (as long as it's > 942)
    local currentY = math.max(rootPart.Position.Y, MIN_Y_LIMIT)
    local horizontalTarget = CFrame.new(targetPart.Position.X, currentY, targetPart.Position.Z)
    
    local hDistance = (rootPart.Position - horizontalTarget.Position).Magnitude
    local hDuration = (speed * hDistance) / 100

    local hTween = TweenService:Create(rootPart, TweenInfo.new(hDuration, Enum.EasingStyle[easingStyle]), {CFrame = horizontalTarget})
    activeTween = hTween
    hTween:Play()
    
    hTween.Completed:Connect(function(playbackState)
        if playbackState == Enum.PlaybackState.Completed then
            -- STAGE 2: Vertical Movement (Y)
            -- Directly up or down to the heart
            local vDistance = math.abs(rootPart.Position.Y - targetPart.Position.Y)
            local vDuration = (speed * vDistance) / 100
            
            local vTween = TweenService:Create(rootPart, TweenInfo.new(vDuration, Enum.EasingStyle[easingStyle]), {CFrame = targetPart.CFrame})
            activeTween = vTween
            vTween:Play()
            
            vTween.Completed:Connect(function()
                stopTween()
            end)
        end
    end)
end

-- Create Window
local Window = Fluent:CreateWindow({
    Title = "CSMDH meth",
    SubTitle = "V1.0.0",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Automation = Window:AddTab({ Title = "Automation", Icon = "play" }),
    Settings = Window:AddTab({ Title = "Config & Webhooks", Icon = "settings" })
}

-- [[ AUTOMATION TAB ]]
Tabs.Automation:AddSection("Devil Heart Detector")

local HopperToggle = Tabs.Automation:AddToggle("HopperToggle", {Title = "Devil Heart Hopper", Default = false })

Tabs.Automation:AddButton({
    Title = "Start Hopper",
    Callback = function()
        if HopperToggle.Value then
            task.spawn(function()
                while HopperToggle.Value do
                    local heart = findDevilHeart()
                    if heart then
                        Fluent:Notify({Title = "Found!", Content = "Heart found. Starting stealth movement.", Duration = 10})
                        tweenToHeart(heart)
                        HopperToggle:SetValue(false)
                        break
                    else
                        -- [Server Hop logic included here]
                        local history = isfile(SERVER_LOG_FILE) and HttpService:JSONDecode(readfile(SERVER_LOG_FILE)) or {}
                        history[game.JobId] = os.time()
                        writefile(SERVER_LOG_FILE, HttpService:JSONEncode(history))
                        local success, result = pcall(function() return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100")) end)
                        if success and result.data then
                            for _, s in ipairs(result.data) do
                                if s.playing < s.maxPlayers and not history[s.id] and s.id ~= game.JobId then
                                    TeleportService:TeleportToPlaceInstance(game.PlaceId, s.id)
                                    return
                                end
                            end
                        end
                    end
                    task.wait(10)
                end
            end)
        end
    end
})

Tabs.Automation:AddButton({
    Title = "Check for Devil Heart",
    Callback = function()
        local heart = findDevilHeart()
        if heart then
            Fluent:Notify({Title = "Found!", Content = "A Devil Heart is in this server.", Duration = 5})
        else
            Fluent:Notify({Title = "Not Found", Content = "No Devil Heart detected.", Duration = 5})
        end
    end
})

Tabs.Automation:AddSection("Movement Settings")

Tabs.Automation:AddInput("TweenSpeed", {
    Title = "Tween Speed",
    Description = "Lower = Faster",
    Default = "0.5",
    Numeric = true,
    Finished = true,
    Callback = function() end
})

Tabs.Automation:AddDropdown("TweenEasing", {
    Title = "Easing Style",
    Values = {"Linear", "Quad", "Sine", "Cubic", "Quart", "Quint"},
    Default = "Linear",
    Callback = function() end
})

Tabs.Automation:AddButton({
    Title = "Tween to Heart",
    Callback = function()
        local heart = findDevilHeart()
        if heart then tweenToHeart(heart) else 
            Fluent:Notify({Title = "Error", Content = "No heart found.", Duration = 3}) 
        end
    end
})

Tabs.Automation:AddButton({
    Title = "Stop Tween",
    Callback = function()
        stopTween()
        Fluent:Notify({Title = "Movement", Content = "Tween Cancelled.", Duration = 3})
    end
})

-- [[ SETTINGS TAB ]]
Tabs.Settings:AddSection("Webhook Settings")
Tabs.Settings:AddInput("WebhookURL", {Title = "Webhook URL", Default = "", Callback = function(v) webhookURL = v end})
Tabs.Settings:AddToggle("WebhookEnable", {Title = "Enable Webhook", Default = false }):OnChanged(function(v) webhookEnabled = v end)

Tabs.Settings:AddSection("Utility")
Tabs.Settings:AddButton({
    Title = "Anti-AFK",
    Callback = function()
        local vu = game:GetService("VirtualUser")
        LocalPlayer.Idled:Connect(function()
            vu:Button2Down(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
            task.wait(1)
            vu:Button2Up(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
        end)
        Fluent:Notify({Title = "Anti-AFK", Content = "Active.", Duration = 3})
    end
})

Tabs.Settings:AddButton({
    Title = "Clear History",
    Callback = function()
        if isfile(SERVER_LOG_FILE) then delfile(SERVER_LOG_FILE) end
        Fluent:Notify({Title = "Success", Content = "History cleared.", Duration = 3})
    end
})

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({"WebhookURL", "TweenSpeed", "TweenEasing"}) 
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()
startFloorCheck()
task.wait(0.5)
isInitialized = true
