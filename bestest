-- [[ LOAD RAYFIELD ]]
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- Constants
local SERVER_LOG_FILE = "rayfield_server_history.json"
local MESH_ID_TARGET = "rbxassetid://12439777368"

-- Helper: Webhook
local function sendWebhook(title, message)
    if _G.Config["WebhookEnabled"] and _G.Config["WebhookURL"] ~= "" then
        pcall(function()
            (request or syn.request)({
                Url = _G.Config["WebhookURL"],
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode({
                    embeds = {{
                        title = title, 
                        description = message, 
                        color = 0x00ff00,
                        timestamp = DateTime.now():ToIsoDate()
                    }}
                })
            })
        end)
    end
end

-- Helper: Server Hopper Logic
local function serverHop()
    local history = isfile(SERVER_LOG_FILE) and HttpService:JSONDecode(readfile(SERVER_LOG_FILE)) or {}
    history[game.JobId] = os.time()
    writefile(SERVER_LOG_FILE, HttpService:JSONEncode(history))

    local result = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    if result and result.data then
        for _, server in ipairs(result.data) do
            if server.playing < server.maxPlayers and not history[server.id] then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

-- Create Window
local Window = Rayfield:CreateWindow({
    Name = "Elite Hopper: " .. (_G.Config["ProfileName"] or "Loaded"),
    LoadingTitle = "Applying Config...",
    ConfigurationSaving = { Enabled = false } -- Disabled internal Rayfield saving as requested
})

local Tab = Window:CreateTab("Status", 4483362458)

-- Displaying current state in UI
Tab:CreateLabel("Current Profile: " .. _G.Config["ProfileName"])
Tab:CreateLabel("Webhook: " .. (_G.Config["WebhookEnabled"] and "Enabled" or "Disabled"))

local StatusLabel = Tab:CreateLabel("Status: Idle")

-- [[ EXECUTION LOGIC ]]
local function startAutomation()
    if _G.Config["ServerHop"] then
        StatusLabel:Set("Status: Searching for Mesh...")
        
        task.spawn(function()
            while _G.Config["ServerHop"] do
                -- Path Check
                local target = workspace:FindFirstChild("map") 
                    and workspace.map:FindFirstChild("Rokyo") 
                    and workspace.map.Rokyo:FindFirstChild("MeshPart")

                if target and target:IsA("MeshPart") and target.MeshId == MESH_ID_TARGET then
                    StatusLabel:Set("Status: FOUND TARGET!")
                    sendWebhook("âœ… Target Found!", "MeshId detected in JobId: " .. game.JobId)
                    break
                else
                    StatusLabel:Set("Status: Not found, hopping...")
                    task.wait(2) -- Short delay to see status
                    serverHop()
                end
                task.wait(10)
            end
        end)
    else
        StatusLabel:Set("Status: Hopper Disabled in Config")
    end
end

-- Initialize based on the Table defined at the start
startAutomation()
