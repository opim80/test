local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- Constants
local SERVER_LOG_FILE = "rayfield_server_history.json"
local MESH_ID_TARGET = "rbxassetid://12439777368"
local LOG_EXPIRY_TIME = 1800 -- 30 minutes

-- Helper: Server History Management
local function getHistory()
    if isfile(SERVER_LOG_FILE) then
        local success, data = pcall(function() return HttpService:JSONDecode(readfile(SERVER_LOG_FILE)) end)
        return success and data or {}
    end
    return {}
end

local function saveHistory(history)
    writefile(SERVER_LOG_FILE, HttpService:JSONEncode(history))
end

local function serverHop()
    local history = getHistory()
    local now = os.time()
    
    -- Clean old logs (older than 30 mins)
    for id, timestamp in pairs(history) do
        if now - timestamp > LOG_EXPIRY_TIME then history[id] = nil end
    end
    
    -- Log current server and save
    history[game.JobId] = now
    saveHistory(history)

    -- Fetch Server List
    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    end)

    if success and result and result.data then
        for _, server in ipairs(result.data) do
            if server.playing < server.maxPlayers and not history[server.id] then
                Rayfield:Notify({
                    Title = "Hopping",
                    Content = "Found new server! Teleporting...",
                    Duration = 5,
                    Image = 4483362458,
                })
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
    Rayfield:Notify({Title = "Error", Content = "No new servers found.", Duration = 3})
end

-- Create Window
local Window = Rayfield:CreateWindow({
    Name = "Server Utility",
    LoadingTitle = "Rayfield Interface",
    LoadingSubtitle = "by Assistant",
    ConfigurationSaving = {
       Enabled = true,
       FolderName = "RayfieldConfigs", 
       FileName = "ServerHopper"
    }
})

local Tab = Window:CreateTab("Automation", 4483362458)

-- Toggle Logic
local isHopping = false
local Toggle = Tab:CreateToggle({
    Name = "Server Hopper (Mesh Detector)",
    CurrentValue = false,
    Flag = "HopperToggle", -- This ensures the state is saved in the config
    Callback = function(Value)
        isHopping = Value
        if isHopping then
            task.spawn(function()
                while isHopping do
                    -- Path check to avoid errors
                    local target = workspace:FindFirstChild("map") 
                        and workspace.map:FindFirstChild("Rokyo") 
                        and workspace.map.Rokyo:FindFirstChild("MeshPart")

                    if target and target:IsA("MeshPart") and target.MeshId == MESH_ID_TARGET then
                        print("found")
                        Rayfield:Notify({
                            Title = "Target Found!",
                            Content = "Detected the MeshPart. Hopping stopped.",
                            Duration = 10,
                            Image = 4483362458,
                        })
                        isHopping = false
                        break
                    else
                        print("Target not in this server. Hopping...")
                        serverHop()
                    end
                    task.wait(10) -- Safety wait before checking/hopping again
                end
            end)
        end
    end,
})

-- Optional: Manual Hop Button
Tab:CreateButton({
    Name = "Force Server Hop",
    Callback = function()
        serverHop()
    end,
})
