-- [[ AUTOMATION TAB ]]
local isInitialized = false -- Logic flag to check if script just loaded
local HopperToggle = Tabs.Automation:AddToggle("HopperToggle", {Title = "Server Hopper (Mesh Detector)", Default = false })

-- The Start Button
local StartButton = Tabs.Automation:AddButton({
    Title = "Start Hopper",
    Description = "Manually start the cycle if toggled on",
    Callback = function()
        if HopperToggle.Value then
            startHopperLoop()
        else
            Fluent:Notify({Title = "Error", Content = "Please enable the Toggle first!", Duration = 3})
        end
    end
})

-- Encapsulated Loop Logic
function startHopperLoop()
    task.spawn(function()
        while HopperToggle.Value do
            local target = workspace:FindFirstChild("map") 
                and workspace.map:FindFirstChild("Rokyo") 
                and workspace.map.Rokyo:FindFirstChild("MeshPart")

            if target and target:IsA("MeshPart") and target.MeshId == MESH_ID_TARGET then
                sendWebhook("âœ… Target Found!", "MeshId matched in server: " .. game.JobId)
                Fluent:Notify({Title = "Success", Content = "Target Found! Hopping stopped.", Duration = 5})
                HopperToggle:SetValue(false)
                break
            else
                serverHop()
            end
            task.wait(10)
        end
    end)
end

-- Toggle Logic
HopperToggle:OnChanged(function()
    -- If the script is already running and you turn the toggle OFF, it stops.
    -- If you turn it ON, we only auto-start if it's the very first time (Config load).
    if HopperToggle.Value and not isInitialized then
        isInitialized = true -- Set this so manual clicks later don't auto-trigger
        startHopperLoop()
    end
end)

-- At the end of your script, after SaveManager:LoadAutoloadConfig()
task.spawn(function()
    task.wait(1) -- Brief wait for SaveManager to apply settings
    if HopperToggle.Value then
        isInitialized = true
        startHopperLoop()
    else
        isInitialized = true -- Mark as initialized even if off, so button is required later
    end
end)
