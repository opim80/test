local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local PathfindingService = game:GetService("PathfindingService")
local Players = game:GetService("Players")

-- Constants
local MESH_ID_TARGET = "rbxassetid://12439777368"
local SERVER_LOG_FILE = "fluent_server_history.json"
local LocalPlayer = Players.LocalPlayer

-- State Variables
local webhookURL = ""
local webhookEnabled = false
local isInitialized = false 

-- Helper: Find Devil Heart
local function findDevilHeart()
    local map = workspace:FindFirstChild("map")
    local rokyos = map and map:FindFirstChild("Rokyo")
    
    if rokyos then
        for _, object in ipairs(rokyos:GetChildren()) do
            if object:IsA("MeshPart") and object.MeshId == MESH_ID_TARGET then
                if object:FindFirstChildOfClass("PointLight") then
                    return object
                end
            end
        end
    end
    return nil
end

-- Helper: Path Visualization
local function visualizePath(waypoints)
    local folder = workspace:FindFirstChild("PathVisuals") or Instance.new("Folder", workspace)
    folder.Name = "PathVisuals"
    folder:ClearAllChildren()

    for _, waypoint in ipairs(waypoints) do
        local part = Instance.new("Part")
        part.Size = Vector3.new(0.5, 0.5, 0.5)
        part.Position = waypoint.Position
        part.Anchored = true
        part.CanCollide = false
        part.Material = Enum.Material.Neon
        part.Color = Color3.fromRGB(0, 255, 0)
        part.Shape = Enum.PartType.Ball
        part.Parent = folder
    end
end

-- Helper: Move with Pathfinding
local function collectHeart(targetPart)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local rootPart = character.HumanoidRootPart
    local destination = targetPart.Position

    local path = PathfindingService:CreatePath({
        AgentRadius = 2,
        AgentHeight = 5,
        AgentCanJump = true,
        AgentWaypointSpacing = 3
    })

    local success, errorMessage = pcall(function()
        path:ComputeAsync(rootPart.Position, destination)
    end)

    if success and path.Status == Enum.PathStatus.Success then
        local waypoints = path:GetWaypoints()
        visualizePath(waypoints)

        for i, waypoint in ipairs(waypoints) do
            -- Jump if required
            if waypoint.Action == Enum.PathWaypointAction.Jump then
                humanoid.Jump = true
            end

            humanoid:MoveTo(waypoint.Position)
            
            -- Wait until reached waypoint or timeout
            local reached = humanoid.MoveToFinished:Wait(1) 
            if not reached then
                -- Re-check distance to waypoint to prevent getting stuck
                if (rootPart.Position - waypoint.Position).Magnitude > 5 then
                    humanoid.Jump = true -- Try to jump over obstacles
                end
            end
        end
        
        -- Clean up visuals
        if workspace:FindFirstChild("PathVisuals") then
            workspace.PathVisuals:ClearAllChildren()
        end
    else
        Fluent:Notify({Title = "Path Error", Content = "Could not find a walkable path to the heart.", Duration = 5})
    end
end

-- Helper: Server History/Webhook
local function sendWebhook(title, message, color)
    if webhookURL ~= "" and webhookURL:find("discord.com/api/webhooks") then
        local data = {["embeds"] = {{["title"] = title, ["description"] = message, ["color"] = color or 0x00ff00, ["timestamp"] = DateTime.now():ToIsoDate()}}}
        pcall(function()
            request({Url = webhookURL, Method = "POST", Headers = {["Content-Type"] = "application/json"}, Body = HttpService:JSONEncode(data)})
        end)
    end
end

local function serverHop()
    local history = isfile(SERVER_LOG_FILE) and HttpService:JSONDecode(readfile(SERVER_LOG_FILE)) or {}
    history[game.JobId] = os.time()
    writefile(SERVER_LOG_FILE, HttpService:JSONEncode(history))

    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    end)

    if success and result and result.data then
        for _, server in ipairs(result.data) do
            if server.playing < server.maxPlayers and not history[server.id] and server.id ~= game.JobId then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

-- Create Window
local Window = Fluent:CreateWindow({
    Title = "Devil Heart Utility v4.0 (Pathfinding)",
    SubTitle = "Visualized Path Edition",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Automation = Window:AddTab({ Title = "Automation", Icon = "play" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- [[ AUTOMATION TAB ]]
Tabs.Automation:AddSection("Devil Heart Detector")

local HopperToggle = Tabs.Automation:AddToggle("HopperToggle", {Title = "Auto-Hop for Devil Heart", Default = false })

Tabs.Automation:AddButton({
    Title = "Start Hopper",
    Description = "Begin searching servers",
    Callback = function()
        if HopperToggle.Value then
            task.spawn(function()
                while HopperToggle.Value do
                    local heart = findDevilHeart()
                    if heart then
                        if webhookEnabled then sendWebhook("✅ Found!", "Heart in: " .. game.JobId) end
                        Fluent:Notify({Title = "Success", Content = "Found! Walking to heart...", Duration = 10})
                        collectHeart(heart)
                        HopperToggle:SetValue(false)
                        break
                    else
                        serverHop()
                    end
                    task.wait(10)
                end
            end)
        end
    end
})

Tabs.Automation:AddButton({
    Title = "Walk to Heart",
    Description = "Uses Pathfinding to walk to the heart",
    Callback = function()
        local heart = findDevilHeart()
        if heart then
            collectHeart(heart)
        else
            Fluent:Notify({Title = "Error", Content = "No Devil Heart found in this server!", Duration = 3})
        end
    end
})

Tabs.Automation:AddParagraph({
    Title = "⚠️ Movement Info",
    Content = "This version uses Roblox Pathfinding Service. It will navigate obstacles and visualize the path with green markers."
})

-- [[ SETTINGS TAB ]]
Tabs.Settings:AddSection("Webhook Settings")
Tabs.Settings:AddInput("WebhookURL", {Title = "Webhook URL", Default = "", Callback = function(v) webhookURL = v end})
Tabs.Settings:AddToggle("WebhookEnable", {Title = "Enable Webhook", Default = false }):OnChanged(function(v) webhookEnabled = v end)

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({"WebhookURL"}) 
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()
task.wait(0.5)
isInitialized = true
