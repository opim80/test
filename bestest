local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local PathfindingService = game:GetService("PathfindingService")
local Players = game:GetService("Players")

-- Constants
local MESH_ID_TARGET = "rbxassetid://12439777368"
local SERVER_LOG_FILE = "fluent_server_history.json"
local LocalPlayer = Players.LocalPlayer

-- State Variables
local webhookURL = ""
local webhookEnabled = false
local isInitialized = false 

-- Helper: Find Devil Heart
local function findDevilHeart()
    local map = workspace:FindFirstChild("map")
    local rokyos = map and map:FindFirstChild("Rokyo")
    if rokyos then
        for _, object in ipairs(rokyos:GetChildren()) do
            if object:IsA("MeshPart") and object.MeshId == MESH_ID_TARGET then
                if object:FindFirstChildOfClass("PointLight") then return object end
            end
        end
    end
    return nil
end

-- Helper: Find Floor for Tween Landing
local function getSafeFloor(startPos)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = {LocalPlayer.Character}
    
    local result = workspace:Raycast(startPos, Vector3.new(0, -500, 0), raycastParams)
    if result then
        return result.Position + Vector3.new(0, 3, 0)
    end
    return startPos
end

-- Pathfinding & Incremental Tween Logic
local function collectHeart(targetPart)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local rootPart = character.HumanoidRootPart
    local destination = targetPart.Position

    -- 1. Attempt Pathfinding First
    local path = PathfindingService:CreatePath({AgentCanJump = true, AgentWaypointSpacing = 4})
    local success, errorMessage = pcall(function() path:ComputeAsync(rootPart.Position, destination) end)

    if success and path.Status == Enum.PathStatus.Success then
        local waypoints = path:GetWaypoints()
        for i, waypoint in ipairs(waypoints) do
            if waypoint.Action == Enum.PathWayPointAction.Jump then humanoid.Jump = true end
            humanoid:MoveTo(waypoint.Position)
            humanoid.MoveToFinished:Wait()
            
            -- Check if path is still viable or if we should switch to Tween
            if (rootPart.Position - destination).Magnitude < 10 then break end
        end
    end

    -- 2. Incremental Tweening (If pathfinding fails or to finish vertical distance)
    while (rootPart.Position - destination).Magnitude > 5 do
        local currentPos = rootPart.Position
        local direction = (destination - currentPos).Unit
        local nextStep = currentPos + (direction * math.min(50, (destination - currentPos).Magnitude))
        
        -- Find a place to stand at this 50-stud increment
        local landingPos = getSafeFloor(nextStep)
        
        local dist = (rootPart.Position - landingPos).Magnitude
        local speed = Fluent.Options.TweenSpeed.Value
        local duration = dist / (speed * 50) -- Adjusted for increments

        local tween = TweenService:Create(rootPart, TweenInfo.new(duration, Enum.EasingStyle.Linear), {CFrame = CFrame.new(landingPos)})
        tween:Play()
        tween.Completed:Wait()

        if (rootPart.Position - destination).Magnitude > 5 then
            task.wait(4) -- Wait 4 seconds between 50-stud increments
        end
    end
end

-- Create Window
local Window = Fluent:CreateWindow({
    Title = "Devil Heart Utility",
    SubTitle = "Pathfinding & Staged Tween",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Automation = Window:AddTab({ Title = "Automation", Icon = "play" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- [[ AUTOMATION TAB ]]
Tabs.Automation:AddSection("Devil Heart Detector")

local HopperToggle = Tabs.Automation:AddToggle("HopperToggle", {Title = "Auto-Hop for Devil Heart", Default = false })

Tabs.Automation:AddButton({
    Title = "Start Hopper",
    Callback = function()
        if HopperToggle.Value then
            task.spawn(function()
                while HopperToggle.Value do
                    local heart = findDevilHeart()
                    if heart then
                        Fluent:Notify({Title = "Found!", Content = "Pathfinding to heart...", Duration = 10})
                        collectHeart(heart)
                        HopperToggle:SetValue(false)
                        break
                    else
                        -- [Your serverHop function code here]
                    end
                    task.wait(10)
                end
            end)
        end
    end
})

Tabs.Automation:AddButton({
    Title = "Check & Pathfind",
    Description = "Manually pathfind to a heart in this server",
    Callback = function()
        local heart = findDevilHeart()
        if heart then collectHeart(heart) else 
            Fluent:Notify({Title = "Not Found", Content = "No Heart detected.", Duration = 3}) 
        end
    end
})

Tabs.Automation:AddSlider("TweenSpeed", {
    Title = "Tween Speed",
    Description = "Controls glide speed during 50-stud increments.",
    Default = 0.5, Min = 0.1, Max = 2, Rounding = 1,
    Callback = function() end
})

Tabs.Automation:AddParagraph({
    Title = "⚠️ Movement Info",
    Content = "The script will walk using pathfinding first. If blocked, it will tween 50 studs, land on the floor, and wait 4 seconds before moving again."
})

-- [[ SETTINGS TAB ]]
-- [InterfaceManager and SaveManager setup here as per previous working versions]

Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()
task.wait(0.5)
isInitialized = true
