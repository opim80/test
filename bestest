local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- Constants
local SETTINGS_FOLDER = "RayfieldConfigs"
local AUTOLOAD_FILE = SETTINGS_FOLDER .. "/autoload.txt"
local SERVER_LOG_FILE = "rayfield_server_history.json"
local MESH_ID_TARGET = "rbxassetid://12439777368"

-- State
local webhookURL = ""
local webhookEnabled = false
local configNameInput = "" 
local isHopping = false -- Starts as false

if makefolder and not isfolder(SETTINGS_FOLDER) then makefolder(SETTINGS_FOLDER) end

-- Helper: Save Fix
local function safeSave()
    pcall(function() Window:Save() end)
    pcall(function() Rayfield:Save() end)
end

-- Helper: Server Hopper Logic
local function serverHop()
    local history = isfile(SERVER_LOG_FILE) and HttpService:JSONDecode(readfile(SERVER_LOG_FILE)) or {}
    history[game.JobId] = os.time()
    writefile(SERVER_LOG_FILE, HttpService:JSONEncode(history))

    local result = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    if result and result.data then
        for _, server in ipairs(result.data) do
            if server.playing < server.maxPlayers and not history[server.id] then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

-- Determine which config file to load
local currentConfigFile = isfile(AUTOLOAD_FILE) and readfile(AUTOLOAD_FILE) or "ServerHopper"

local Window = Rayfield:CreateWindow({
    Name = "Elite Hopper Manager",
    LoadingTitle = "Rayfield Recode",
    ConfigurationSaving = {
       Enabled = true,
       FolderName = SETTINGS_FOLDER, 
       FileName = currentConfigFile
    }
})

local Tab = Window:CreateTab("Automation", 4483362458)
local ConfigTab = Window:CreateTab("Config & Webhooks", 4483362458)

-- [[ AUTOMATION ]]
Tab:CreateToggle({
    Name = "Server Hopper",
    CurrentValue = false, -- Default to false if no config exists
    Flag = "HopperToggle",
    Callback = function(Value)
        isHopping = Value
        
        -- The loop only starts if 'Value' is true. 
        -- If the config is missing or false, this block is skipped.
        if isHopping then
            task.spawn(function()
                -- Wait for UI to settle and ensure the state is saved
                safeSave()
                task.wait(1) 

                while isHopping do
                    local target = workspace:FindFirstChild("map") 
                        and workspace.map:FindFirstChild("Rokyo") 
                        and workspace.map.Rokyo:FindFirstChild("MeshPart")

                    if target and target:IsA("MeshPart") and target.MeshId == MESH_ID_TARGET then
                        isHopping = false
                        break
                    else
                        serverHop()
                    end
                    task.wait(10)
                end
            end)
        end
    end,
})

-- [[ CONFIGURATION ]]
ConfigTab:CreateInput({
    Name = "Profile Name",
    PlaceholderText = "Type name here...",
    Callback = function(Text) configNameInput = Text end,
})

ConfigTab:CreateButton({
    Name = "Save Settings",
    Callback = function()
        if configNameInput ~= "" then
            Window.ConfigurationSaving.FileName = configNameInput
            safeSave()
            Rayfield:Notify({Title = "Saved", Content = "Config: " .. configNameInput, Duration = 3})
        else
            Rayfield:Notify({Title = "Error", Content = "Enter a name first!", Duration = 3})
        end
    end,
})

ConfigTab:CreateButton({
    Name = "Set as Default (Autoload)",
    Callback = function()
        if configNameInput ~= "" then
            writefile(AUTOLOAD_FILE, configNameInput)
            Rayfield:Notify({Title = "Success", Content = configNameInput .. " is now default.", Duration = 3})
        end
    end,
})
