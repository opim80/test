local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- Constants
local SETTINGS_FOLDER = "RayfieldConfigs"
local AUTOLOAD_FILE = SETTINGS_FOLDER .. "/autoload.txt"
local SERVER_LOG_FILE = "rayfield_server_history.json"
local MESH_ID_TARGET = "rbxassetid://12439777368"

-- State
local webhookURL = ""
local webhookEnabled = false
local configNameInput = "" -- Required for saving
local isHopping = false

if makefolder and not isfolder(SETTINGS_FOLDER) then makefolder(SETTINGS_FOLDER) end

-- Helper: Universal Save Function
local function safeSave()
    local success = pcall(function() Window:Save() end)
    if not success then pcall(function() Rayfield:Save() end) end
end

-- Helper: Webhook
local function sendWebhook(title, message)
    if webhookEnabled and webhookURL ~= "" then
        pcall(function()
            (request or syn.request)({
                Url = webhookURL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode({
                    embeds = {{title = title, description = message, color = 0x00ff00}}
                })
            })
        end)
    end
end

-- Helper: Server Hopper Logic
local function serverHop()
    local history = isfile(SERVER_LOG_FILE) and HttpService:JSONDecode(readfile(SERVER_LOG_FILE)) or {}
    history[game.JobId] = os.time()
    writefile(SERVER_LOG_FILE, HttpService:JSONEncode(history))

    local result = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    if result and result.data then
        for _, server in ipairs(result.data) do
            if server.playing < server.maxPlayers and not history[server.id] then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

-- Load Autoloaded Config Name
local currentConfigFile = isfile(AUTOLOAD_FILE) and readfile(AUTOLOAD_FILE) or "ServerHopper"

local Window = Rayfield:CreateWindow({
    Name = "Elite Hopper & Config Manager",
    LoadingTitle = "Rayfield Recode",
    ConfigurationSaving = {
       Enabled = true,
       FolderName = SETTINGS_FOLDER, 
       FileName = currentConfigFile
    }
})

local Tab = Window:CreateTab("Automation", 4483362458)
local ConfigTab = Window:CreateTab("Config & Webhooks", 4483362458)

-- [[ AUTOMATION ]]
Tab:CreateToggle({
    Name = "Safe-Save Server Hopper",
    CurrentValue = false,
    Flag = "HopperToggle",
    Callback = function(Value)
        isHopping = Value
        if isHopping then
            -- FIRST: Ensure state is saved to disk before hopping
            Rayfield:Notify({Title = "Saving State...", Content = "Committing toggle to config before first hop.", Duration = 2})
            safeSave()
            task.wait(1.5) -- Buffer for file write

            task.spawn(function()
                while isHopping do
                    local target = workspace:FindFirstChild("map") 
                        and workspace.map:FindFirstChild("Rokyo") 
                        and workspace.map.Rokyo:FindFirstChild("MeshPart")

                    if target and target:IsA("MeshPart") and target.MeshId == MESH_ID_TARGET then
                        sendWebhook("âœ… Target Found!", "MeshId matched in server: " .. game.JobId)
                        isHopping = false
                        break
                    else
                        serverHop()
                    end
                    task.wait(10)
                end
            end)
        end
    end,
})

-- [[ CONFIG & WEBHOOKS ]]
ConfigTab:CreateSection("Webhook Settings")

ConfigTab:CreateInput({
    Name = "Webhook URL",
    PlaceholderText = "Paste Discord Webhook...",
    Flag = "W_URL",
    Callback = function(Text) webhookURL = Text end,
})

ConfigTab:CreateToggle({
    Name = "Enable Webhook",
    CurrentValue = false,
    Flag = "W_Toggle",
    Callback = function(Value) webhookEnabled = Value end,
})

ConfigTab:CreateSection("Configuration Manager")

ConfigTab:CreateInput({
    Name = "Profile Name",
    PlaceholderText = "e.g. MySuperConfig",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        configNameInput = Text
    end,
})

ConfigTab:CreateButton({
    Name = "Save Current Settings",
    Callback = function()
        if configNameInput == "" then
            Rayfield:Notify({Title = "Error", Content = "Please enter a Profile Name above first!", Duration = 3})
        else
            -- We update the filename choice for Rayfield's internal system
            Window.ConfigurationSaving.FileName = configNameInput
            safeSave()
            Rayfield:Notify({Title = "Saved!", Content = "Config saved as: " .. configNameInput, Duration = 3})
        end
    end,
})

ConfigTab:CreateButton({
    Name = "Set Current Profile to Autoload",
    Callback = function()
        if configNameInput == "" then
            Rayfield:Notify({Title = "Error", Content = "Enter a name to set it as default!", Duration = 3})
        else
            writefile(AUTOLOAD_FILE, configNameInput)
            Rayfield:Notify({Title = "Autoload Set", Content = configNameInput .. " will load next time.", Duration = 3})
        end
    end,
})

ConfigTab:CreateButton({
    Name = "Test Webhook",
    Callback = function()
        sendWebhook("Test", "Webhook working!")
    end,
})
