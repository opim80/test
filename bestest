local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- Constants
local SERVER_LOG_FILE = "rayfield_server_history.json"
local MESH_ID_TARGET = "rbxassetid://12439777368"
local LOG_EXPIRY_TIME = 1800 

-- Global Variables for Webhook
local webhookURL = ""
local webhookEnabled = false

-- Helper: Send Discord Webhook
local function sendWebhook(message)
    if webhookEnabled and webhookURL ~= "" and webhookURL:find("discord.com/api/webhooks") then
        local data = {
            ["content"] = "",
            ["embeds"] = {{
                ["title"] = "Server Hopper Notification",
                ["description"] = message,
                ["color"] = tonumber(0x00ff00),
                ["footer"] = { ["text"] = "Rayfield Automation" },
                ["timestamp"] = DateTime.now():ToIsoDate()
            }}
        }
        local jsonData = HttpService:JSONEncode(data)
        pcall(function()
            request({
                Url = webhookURL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = jsonData
            })
        end)
    end
end

-- Helper: Server History Management
local function getHistory()
    if isfile(SERVER_LOG_FILE) then
        local success, data = pcall(function() return HttpService:JSONDecode(readfile(SERVER_LOG_FILE)) end)
        return success and data or {}
    end
    return {}
end

local function saveHistory(history)
    writefile(SERVER_LOG_FILE, HttpService:JSONEncode(history))
end

local function serverHop()
    local history = getHistory()
    local now = os.time()
    for id, timestamp in pairs(history) do
        if now - timestamp > LOG_EXPIRY_TIME then history[id] = nil end
    end
    history[game.JobId] = now
    saveHistory(history)

    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    end)

    if success and result and result.data then
        for _, server in ipairs(result.data) do
            if server.playing < server.maxPlayers and not history[server.id] then
                Rayfield:Notify({
                    Title = "Hopping",
                    Content = "Found new server! Teleporting...",
                    Duration = 5,
                    Image = 4483362458,
                })
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

-- Create Window
local Window = Rayfield:CreateWindow({
    Name = "Server Utility",
    LoadingTitle = "Rayfield Interface",
    LoadingSubtitle = "by Assistant",
    ConfigurationSaving = {
       Enabled = true,
       FolderName = "RayfieldConfigs", 
       FileName = "ServerHopper"
    }
})

local Tab = Window:CreateTab("Automation", 4483362458)
local ConfigTab = Window:CreateTab("Config/Webhooks", 4483362458)

-- [[ AUTOMATION TAB ]]
local isHopping = false
Tab:CreateToggle({
    Name = "Server Hopper (Mesh Detector)",
    CurrentValue = false,
    Flag = "HopperToggle",
    Callback = function(Value)
        isHopping = Value
        if isHopping then
            task.spawn(function()
                while isHopping do
                    local target = workspace:FindFirstChild("map") 
                        and workspace.map:FindFirstChild("Rokyo") 
                        and workspace.map.Rokyo:FindFirstChild("MeshPart")

                    if target and target:IsA("MeshPart") and target.MeshId == MESH_ID_TARGET then
                        print("found")
                        sendWebhook("âœ… Target MeshPart found in Server: " .. game.JobId)
                        Rayfield:Notify({
                            Title = "Target Found!",
                            Content = "Detected the MeshPart. Hopping stopped.",
                            Duration = 10,
                            Image = 4483362458,
                        })
                        isHopping = false
                        break
                    else
                        serverHop()
                    end
                    task.wait(10)
                end
            end)
        end
    end,
})

Tab:CreateButton({
    Name = "Force Server Hop",
    Callback = function()
        serverHop()
    end,
})

-- [[ CONFIG & WEBHOOK TAB ]]
ConfigTab:CreateSection("Webhook Settings")

ConfigTab:CreateInput({
    Name = "Discord Webhook URL",
    PlaceholderText = "Paste URL here...",
    RemoveTextAfterFocusLost = false,
    Flag = "WebhookURL",
    Callback = function(Text)
        webhookURL = Text
    end,
})

ConfigTab:CreateToggle({
    Name = "Enable Webhook Notifications",
    CurrentValue = false,
    Flag = "WebhookToggle",
    Callback = function(Value)
        webhookEnabled = Value
    end,
})

ConfigTab:CreateSection("Configuration")

ConfigTab:CreateButton({
    Name = "Save Current Config",
    Callback = function()
        Rayfield:SaveConfiguration()
        Rayfield:Notify({
            Title = "Success",
            Content = "Configuration has been saved!",
            Duration = 3,
            Image = 4483362458,
        })
    end,
})
