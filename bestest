local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- Constants
local CONFIG_DIR = "Rayfield_Configs"
local AUTOLOAD_PATH = CONFIG_DIR .. "/autoload_pref.txt"
local SERVER_LOG = "server_history.json"
local MESH_ID_TARGET = "rbxassetid://12439777368"

-- Initialization
if makefolder and not isfolder(CONFIG_DIR) then makefolder(CONFIG_DIR) end

-- State
local configName = ""
local webhookURL = ""
local webhookEnabled = false
local isHopping = false

-- Helper: Custom Save Logic (Bypasses library bugs)
local function manualSave(filename)
    if filename == "" then 
        Rayfield:Notify({Title = "Error", Content = "You must enter a name first!", Duration = 3})
        return false 
    end
    
    local data = {
        webhookURL = webhookURL,
        webhookEnabled = webhookEnabled,
        isHopping = isHopping
    }
    
    local path = CONFIG_DIR .. "/" .. filename .. ".json"
    writefile(path, HttpService:JSONEncode(data))
    Rayfield:Notify({Title = "Success", Content = "Config saved to: " .. filename, Duration = 3})
    return true
end

-- Helper: Discord Webhook
local function sendWebhook(msg)
    if webhookEnabled and webhookURL ~= "" then
        pcall(function()
            request({
                Url = webhookURL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode({content = msg})
            })
        end)
    end
end

-- Helper: Server Hopper
local function serverHop()
    local history = isfile(SERVER_LOG) and HttpService:JSONDecode(readfile(SERVER_LOG)) or {}
    history[game.JobId] = os.time()
    writefile(SERVER_LOG, HttpService:JSONEncode(history))

    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    end)

    if success and result.data then
        for _, server in ipairs(result.data) do
            if server.playing < server.maxPlayers and not history[server.id] then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

-- Window Setup
local Window = Rayfield:CreateWindow({
    Name = "Ultimate Server Hopper",
    LoadingTitle = "Loading Automation...",
    ConfigurationSaving = { Enabled = false } -- We are using our custom manual system for reliability
})

local MainTab = Window:CreateTab("Automation", 4483362458)
local ConfigTab = Window:CreateTab("Configs", 4483362458)

-- [[ AUTOMATION ]]
MainTab:CreateToggle({
    Name = "Enable Server Hopper",
    CurrentValue = false,
    Callback = function(Value)
        isHopping = Value
        if isHopping then
            -- INSTANT SAVE logic
            if configName ~= "" then manualSave(configName) end
            
            task.spawn(function()
                while isHopping do
                    local target = workspace:FindFirstChild("map") 
                        and workspace.map:FindFirstChild("Rokyo") 
                        and workspace.map.Rokyo:FindFirstChild("MeshPart")

                    if target and target.MeshId == MESH_ID_TARGET then
                        sendWebhook("âœ… Target Found in Job: " .. game.JobId)
                        isHopping = false
                        break
                    else
                        serverHop()
                    end
                    task.wait(10)
                end
            end)
        end
    end,
})

-- [[ CONFIGS ]]
ConfigTab:CreateSection("Naming")

ConfigTab:CreateInput({
    Name = "New Config Name",
    PlaceholderText = "Required to save...",
    Callback = function(Text)
        configName = Text
    end,
})

ConfigTab:CreateSection("Settings")

ConfigTab:CreateInput({
    Name = "Webhook URL",
    PlaceholderText = "Paste here...",
    Callback = function(Text) webhookURL = Text end,
})

ConfigTab:CreateToggle({
    Name = "Webhook Notifications",
    CurrentValue = false,
    Callback = function(Value) webhookEnabled = Value end,
})

ConfigTab:CreateButton({
    Name = "Test Webhook",
    Callback = function()
        local success = sendWebhook("Test: Webhook is working correctly!")
        Rayfield:Notify({Title = "Status", Content = success and "Sent!" or "Failed (Check URL)", Duration = 3})
    end,
})

ConfigTab:CreateSection("Save/Load")

ConfigTab:CreateButton({
    Name = "Save Current Config",
    Callback = function()
        manualSave(configName)
    end,
})

ConfigTab:CreateButton({
    Name = "Set as Autoload",
    Callback = function()
        if configName ~= "" then
            writefile(AUTOLOAD_PATH, configName)
            Rayfield:Notify({Title = "Autoload", Content = configName .. " set as default.", Duration = 3})
        else
            Rayfield:Notify({Title = "Error", Content = "Enter a name first!", Duration = 3})
        end
    end,
})
