local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- Constants
local SETTINGS_FOLDER = "RayfieldConfigs"
local AUTOLOAD_FILE = SETTINGS_FOLDER .. "/autoload.txt"
local SERVER_LOG_FILE = "rayfield_server_history.json"
local MESH_ID_TARGET = "rbxassetid://12439777368"
local LOG_EXPIRY_TIME = 1800 

-- State Variables
local webhookURL = ""
local webhookEnabled = false
local selectedConfig = "ServerHopper"

-- Ensure folder exists
if makefolder and not isfolder(SETTINGS_FOLDER) then makefolder(SETTINGS_FOLDER) end

-- Helper: Send Discord Webhook
local function sendWebhook(title, message, color)
    if webhookURL ~= "" and webhookURL:find("discord.com/api/webhooks") then
        local data = {
            ["embeds"] = {{
                ["title"] = title,
                ["description"] = message,
                ["color"] = color or 0x00ff00,
                ["timestamp"] = DateTime.now():ToIsoDate()
            }}
        }
        local success, err = pcall(function()
            request({
                Url = webhookURL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(data)
            })
        end)
        return success
    end
    return false
end

-- Helper: Server History
local function getHistory()
    if isfile(SERVER_LOG_FILE) then
        local success, data = pcall(function() return HttpService:JSONDecode(readfile(SERVER_LOG_FILE)) end)
        return success and data or {}
    end
    return {}
end

local function serverHop()
    local history = getHistory()
    history[game.JobId] = os.time()
    writefile(SERVER_LOG_FILE, HttpService:JSONEncode(history))

    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    end)

    if success and result and result.data then
        for _, server in ipairs(result.data) do
            if server.playing < server.maxPlayers and not history[server.id] then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id)
                return
            end
        end
    end
end

-- Determine Autoload File
local currentConfigFile = "ServerHopper"
if isfile(AUTOLOAD_FILE) then
    currentConfigFile = readfile(AUTOLOAD_FILE)
end

-- Create Window
local Window = Rayfield:CreateWindow({
    Name = "Premium Server Utility",
    LoadingTitle = "Rayfield Interface",
    LoadingSubtitle = "Config & Webhook Edition",
    ConfigurationSaving = {
       Enabled = true,
       FolderName = SETTINGS_FOLDER, 
       FileName = currentConfigFile
    }
})

local Tab = Window:CreateTab("Automation", 4483362458)
local ConfigTab = Window:CreateTab("Config & Webhooks", 4483362458)

-- [[ AUTOMATION TAB ]]
local isHopping = false
Tab:CreateToggle({
    Name = "Server Hopper (Mesh Detector)",
    CurrentValue = false,
    Flag = "HopperToggle",
    Callback = function(Value)
        isHopping = Value
        if isHopping then
            task.spawn(function()
                while isHopping do
                    local target = workspace:FindFirstChild("map") 
                        and workspace.map:FindFirstChild("Rokyo") 
                        and workspace.map.Rokyo:FindFirstChild("MeshPart")

                    if target and target:IsA("MeshPart") and target.MeshId == MESH_ID_TARGET then
                        sendWebhook("âœ… Target Found!", "MeshId matched in server: " .. game.JobId)
                        Rayfield:Notify({Title = "Success", Content = "Target Found! Hopping stopped.", Duration = 5})
                        isHopping = false
                        break
                    else
                        serverHop()
                    end
                    task.wait(10)
                end
            end)
        end
    end,
})

-- [[ CONFIG & WEBHOOK TAB ]]
ConfigTab:CreateSection("Webhook Settings")

ConfigTab:CreateInput({
    Name = "Webhook URL",
    PlaceholderText = "Discord Webhook Link...",
    Flag = "W_URL",
    Callback = function(Text) webhookURL = Text end,
})

ConfigTab:CreateToggle({
    Name = "Enable Webhook",
    CurrentValue = false,
    Flag = "W_Toggle",
    Callback = function(Value) webhookEnabled = Value end,
})

ConfigTab:CreateButton({
    Name = "Test Webhook",
    Callback = function()
        local ok = sendWebhook("Test Message", "Your webhook is configured correctly!", 0x5865F2)
        Rayfield:Notify({
            Title = ok and "Sent!" or "Failed",
            Content = ok and "Check your Discord channel." or "URL is invalid or empty.",
            Duration = 3
        })
    end,
})

ConfigTab:CreateSection("Configuration Manager")

ConfigTab:CreateDropdown({
    Name = "Select Config Profile",
    Options = {"ServerHopper", "Profile_1", "Profile_2", "Custom"},
    CurrentOption = {currentConfigFile},
    MultipleOptions = false,
    Callback = function(Option)
        selectedConfig = Option[1]
    end,
})

ConfigTab:CreateButton({
    Name = "Load Selected Config",
    Callback = function()
        -- Note: Rayfield doesn't support hot-swapping filenames mid-session easily.
        -- This saves the preference for next execution.
        writefile(AUTOLOAD_FILE, selectedConfig)
        Rayfield:Notify({
            Title = "Config Set",
            Content = "Profile '" .. selectedConfig .. "' will load on next restart.",
            Duration = 5
        })
    end,
})

ConfigTab:CreateButton({
    Name = "Set as Autoload",
    Callback = function()
        writefile(AUTOLOAD_FILE, selectedConfig)
        Rayfield:Notify({
            Title = "Autoload Saved",
            Content = selectedConfig .. " is now your default profile.",
            Duration = 3
        })
    end,
})

ConfigTab:CreateButton({
    Name = "Save Current Settings",
    Callback = function()
        Rayfield:SaveSettings() -- Correct method name
        Rayfield:Notify({Title = "Saved", Content = "Settings written to " .. selectedConfig .. ".lua", Duration = 3})
    end,
})
